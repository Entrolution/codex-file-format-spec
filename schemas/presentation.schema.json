{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://codex.document/schemas/presentation.schema.json",
  "title": "Codex Presentation Layer",
  "description": "Schema for presentation layer files in a Codex document",
  "type": "object",
  "required": ["version", "type", "defaults", "styles"],
  "properties": {
    "version": {
      "type": "string",
      "description": "Presentation format version",
      "pattern": "^\\d+\\.\\d+$"
    },
    "type": {
      "type": "string",
      "description": "Presentation type",
      "enum": ["paginated", "continuous", "responsive"]
    },
    "defaults": {
      "type": "object",
      "description": "Default styling values"
    },
    "pages": {
      "type": "array",
      "description": "Page definitions (paginated only)",
      "items": {
        "$ref": "#/$defs/page"
      }
    },
    "sections": {
      "type": "array",
      "description": "Section definitions (continuous only)",
      "items": {
        "$ref": "#/$defs/section"
      }
    },
    "breakpoints": {
      "type": "array",
      "description": "Responsive breakpoints",
      "items": {
        "$ref": "#/$defs/breakpoint"
      }
    },
    "pageTemplate": {
      "$ref": "#/$defs/pageTemplate"
    },
    "layout": {
      "$ref": "#/$defs/layout"
    },
    "flowRegions": {
      "type": "array",
      "description": "Flow region definitions for text flow across pages/areas",
      "items": {
        "$ref": "#/$defs/flowRegion"
      }
    },
    "print": {
      "$ref": "#/$defs/printSettings"
    },
    "masterPages": {
      "type": "object",
      "description": "Master page template definitions",
      "additionalProperties": {
        "$ref": "#/$defs/masterPage"
      }
    },
    "masterRules": {
      "type": "array",
      "description": "Auto-application rules for master pages",
      "items": {
        "$ref": "#/$defs/masterRule"
      }
    },
    "colors": {
      "type": "object",
      "description": "Named color definitions including spot colors",
      "additionalProperties": {
        "$ref": "#/$defs/colorDefinition"
      }
    },
    "tableOfContents": {
      "$ref": "#/$defs/tableOfContentsConfig"
    },
    "listOfFigures": {
      "$ref": "#/$defs/listOfConfig"
    },
    "listOfTables": {
      "$ref": "#/$defs/listOfConfig"
    },
    "index": {
      "$ref": "#/$defs/indexConfig"
    },
    "footnotes": {
      "$ref": "#/$defs/footnotesConfig"
    },
    "endnotes": {
      "$ref": "#/$defs/endnotesConfig"
    },
    "styles": {
      "type": "object",
      "description": "Style definitions",
      "additionalProperties": {
        "$ref": "#/$defs/style"
      }
    },
    "typography": {
      "type": "object",
      "description": "Document-level typography settings",
      "properties": {
        "hyphenation": {
          "type": "object",
          "description": "Hyphenation settings",
          "properties": {
            "enabled": { "type": "boolean" },
            "language": { "type": "string" },
            "minWordLength": { "type": "integer", "minimum": 1 },
            "minBefore": { "type": "integer", "minimum": 1 },
            "minAfter": { "type": "integer", "minimum": 1 },
            "maxConsecutive": { "type": "integer", "minimum": 1 }
          }
        },
        "widows": {
          "type": "integer",
          "description": "Minimum lines at top of page",
          "minimum": 1
        },
        "orphans": {
          "type": "integer",
          "description": "Minimum lines at bottom of page",
          "minimum": 1
        },
        "baselineGrid": {
          "type": "object",
          "description": "Baseline grid settings",
          "properties": {
            "enabled": { "type": "boolean" },
            "lineHeight": { "type": "string" },
            "offset": { "type": "string" }
          }
        },
        "lineNumbering": { "$ref": "#/$defs/lineNumbering" }
      }
    }
  },
  "$defs": {
    "page": {
      "type": "object",
      "required": ["number", "elements"],
      "properties": {
        "number": {
          "type": "integer",
          "minimum": 1,
          "description": "Page number"
        },
        "elements": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/pageElement"
          }
        }
      }
    },
    "pageElement": {
      "type": "object",
      "required": ["blockId", "position"],
      "properties": {
        "blockId": {
          "type": "string",
          "description": "Reference to content block ID"
        },
        "position": {
          "$ref": "#/$defs/position"
        },
        "style": {
          "type": "string",
          "description": "Named style to apply"
        },
        "overflow": {
          "type": "string",
          "enum": ["visible", "hidden", "flow"],
          "description": "Overflow behavior"
        },
        "zIndex": {
          "type": "integer",
          "description": "Stacking order (higher values render on top)"
        },
        "transform": {
          "$ref": "#/$defs/transform"
        }
      }
    },
    "position": {
      "type": "object",
      "required": ["x", "y", "width"],
      "properties": {
        "x": {
          "type": "string",
          "description": "X position"
        },
        "y": {
          "type": "string",
          "description": "Y position"
        },
        "width": {
          "type": "string",
          "description": "Width"
        },
        "height": {
          "type": "string",
          "description": "Height",
          "default": "auto"
        }
      }
    },
    "transform": {
      "type": "object",
      "description": "Transform properties for rotation, scaling, and skewing",
      "properties": {
        "rotate": {
          "type": "string",
          "description": "Rotation angle (e.g., '90deg', '-45deg', '0.5rad', '0.25turn')"
        },
        "scale": {
          "oneOf": [
            { "type": "number", "description": "Uniform scale factor" },
            {
              "type": "object",
              "properties": {
                "x": { "type": "number" },
                "y": { "type": "number" }
              },
              "required": ["x", "y"]
            }
          ]
        },
        "skewX": {
          "type": "string",
          "description": "Horizontal skew angle"
        },
        "skewY": {
          "type": "string",
          "description": "Vertical skew angle"
        },
        "translateX": {
          "type": "string",
          "description": "Horizontal translation"
        },
        "translateY": {
          "type": "string",
          "description": "Vertical translation"
        },
        "matrix": {
          "type": "array",
          "items": { "type": "number" },
          "minItems": 6,
          "maxItems": 6,
          "description": "Full 2D transform matrix [a, b, c, d, tx, ty]"
        },
        "origin": {
          "oneOf": [
            { "type": "string", "description": "Transform origin (e.g., 'center', 'top left')" },
            {
              "type": "object",
              "properties": {
                "x": { "type": "string" },
                "y": { "type": "string" }
              },
              "required": ["x", "y"]
            }
          ]
        }
      }
    },
    "section": {
      "type": "object",
      "required": ["blockRefs"],
      "properties": {
        "blockRefs": {
          "type": "array",
          "items": { "type": "string" },
          "description": "References to content block IDs"
        },
        "style": {
          "type": "string",
          "description": "Named style to apply"
        },
        "attributes": {
          "type": "object",
          "description": "Inline style attributes",
          "additionalProperties": true
        }
      },
      "additionalProperties": false
    },
    "breakpoint": {
      "type": "object",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Breakpoint name"
        },
        "minWidth": {
          "type": "string",
          "description": "Minimum viewport width"
        },
        "maxWidth": {
          "type": "string",
          "description": "Maximum viewport width"
        }
      },
      "additionalProperties": false
    },
    "pageTemplate": {
      "type": "object",
      "properties": {
        "header": {
          "$ref": "#/$defs/pageHeaderFooter"
        },
        "footer": {
          "$ref": "#/$defs/pageHeaderFooter"
        },
        "odd": {
          "type": "object",
          "description": "Template for odd pages",
          "properties": {
            "header": { "$ref": "#/$defs/pageHeaderFooter" },
            "footer": { "$ref": "#/$defs/pageHeaderFooter" }
          }
        },
        "even": {
          "type": "object",
          "description": "Template for even pages",
          "properties": {
            "header": { "$ref": "#/$defs/pageHeaderFooter" },
            "footer": { "$ref": "#/$defs/pageHeaderFooter" }
          }
        }
      }
    },
    "layout": {
      "type": "object",
      "description": "Page layout configuration",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["columns", "grid"],
          "description": "Layout type"
        },
        "columns": {
          "type": "integer",
          "minimum": 1,
          "maximum": 12,
          "description": "Number of columns"
        },
        "rows": {
          "oneOf": [
            { "type": "string", "const": "auto" },
            { "type": "integer", "minimum": 1 }
          ],
          "description": "Number of rows (grid layout)"
        },
        "gap": {
          "type": "string",
          "description": "Gap between columns/cells"
        },
        "balance": {
          "type": "boolean",
          "description": "Balance column heights"
        },
        "rule": {
          "type": "object",
          "description": "Column rule (separator line)",
          "properties": {
            "width": { "type": "string" },
            "style": { "type": "string" },
            "color": { "type": "string" }
          }
        },
        "areas": {
          "type": "array",
          "description": "Grid area definitions",
          "items": {
            "type": "object",
            "required": ["name"],
            "properties": {
              "name": { "type": "string" },
              "column": { "type": "string" },
              "row": { "type": "string" }
            }
          }
        }
      }
    },
    "flowRegion": {
      "type": "object",
      "description": "Flow region definition for text flow",
      "required": ["id", "regions"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Flow region identifier"
        },
        "regions": {
          "type": "array",
          "description": "Ordered list of regions for text flow",
          "items": {
            "type": "object",
            "properties": {
              "page": { "type": "integer", "minimum": 1 },
              "area": { "type": "string" }
            }
          }
        }
      }
    },
    "printSettings": {
      "type": "object",
      "description": "Print-specific settings",
      "properties": {
        "bleed": {
          "type": "object",
          "description": "Bleed area for printing",
          "properties": {
            "top": { "type": "string" },
            "right": { "type": "string" },
            "bottom": { "type": "string" },
            "left": { "type": "string" }
          }
        },
        "trim": {
          "type": "object",
          "description": "Trim box dimensions",
          "properties": {
            "width": { "type": "string" },
            "height": { "type": "string" }
          }
        },
        "cropMarks": {
          "type": "boolean",
          "description": "Include crop marks"
        },
        "registrationMarks": {
          "type": "boolean",
          "description": "Include registration marks"
        },
        "colorBars": {
          "type": "boolean",
          "description": "Include color bars"
        },
        "standard": {
          "type": "string",
          "description": "PDF standard compliance",
          "enum": ["PDF/X-1a", "PDF/X-3", "PDF/X-4", "PDF/A-1", "PDF/A-2", "PDF/A-3"]
        },
        "outputIntent": {
          "type": "object",
          "description": "Output intent for color management",
          "properties": {
            "profile": { "type": "string" },
            "condition": { "type": "string" }
          }
        }
      }
    },
    "masterPage": {
      "type": "object",
      "description": "Master page template definition",
      "properties": {
        "basedOn": {
          "type": "string",
          "description": "Parent master page name"
        },
        "margins": {
          "type": "object",
          "properties": {
            "top": { "type": "string" },
            "right": { "type": "string" },
            "bottom": { "type": "string" },
            "left": { "type": "string" },
            "inside": { "type": "string" },
            "outside": { "type": "string" }
          }
        },
        "header": {
          "oneOf": [
            { "type": "null" },
            { "$ref": "#/$defs/pageHeaderFooter" }
          ]
        },
        "footer": {
          "oneOf": [
            { "type": "null" },
            { "$ref": "#/$defs/pageHeaderFooter" }
          ]
        }
      }
    },
    "masterRule": {
      "type": "object",
      "description": "Auto-application rule for master pages",
      "required": ["match", "master"],
      "properties": {
        "match": {
          "type": "object",
          "description": "Match criteria",
          "properties": {
            "first": { "type": "boolean" },
            "last": { "type": "boolean" },
            "contains": { "type": "string" },
            "default": { "type": "boolean" }
          }
        },
        "master": {
          "type": "string",
          "description": "Master page name to apply"
        }
      }
    },
    "colorDefinition": {
      "type": "object",
      "description": "Color definition including spot colors",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["rgb", "cmyk", "spot"],
          "description": "Color type"
        },
        "name": {
          "type": "string",
          "description": "Spot color name (e.g., PANTONE 286 C)"
        },
        "fallback": {
          "type": "string",
          "description": "Fallback hex color for non-spot rendering"
        },
        "value": {
          "type": "string",
          "description": "Color value (hex for RGB, CMYK values for CMYK)"
        }
      }
    },
    "tableOfContentsConfig": {
      "type": "object",
      "description": "Table of contents generation settings",
      "properties": {
        "title": {
          "type": "string",
          "description": "TOC section title"
        },
        "levels": {
          "type": "array",
          "description": "Heading levels to include",
          "items": {
            "type": "integer",
            "minimum": 1,
            "maximum": 6
          }
        },
        "styles": {
          "type": "object",
          "description": "Style names for each TOC level",
          "additionalProperties": { "$ref": "#/$defs/style" }
        },
        "pageNumbers": {
          "type": "boolean",
          "description": "Include page numbers"
        },
        "leaders": {
          "type": "string",
          "enum": ["none", "dots", "dashes", "underline"],
          "description": "Leader style between title and page number"
        }
      }
    },
    "listOfConfig": {
      "type": "object",
      "description": "List of figures/tables configuration",
      "properties": {
        "title": {
          "type": "string",
          "description": "Section title"
        },
        "style": {
          "type": "string",
          "description": "Named style to apply"
        }
      }
    },
    "indexConfig": {
      "type": "object",
      "description": "Index generation settings",
      "properties": {
        "title": {
          "type": "string",
          "description": "Index section title"
        },
        "columns": {
          "type": "integer",
          "minimum": 1,
          "maximum": 4,
          "description": "Number of columns for index layout"
        },
        "style": {
          "type": "object",
          "description": "Styling for index entries",
          "properties": {
            "mainEntry": { "$ref": "#/$defs/style" },
            "subEntry": { "$ref": "#/$defs/style" }
          }
        }
      }
    },
    "footnotesConfig": {
      "type": "object",
      "description": "Footnote rendering settings",
      "properties": {
        "numbering": {
          "type": "string",
          "description": "Numbering style",
          "enum": ["1", "a", "A", "i", "I", "*"]
        },
        "position": {
          "type": "string",
          "enum": ["page-bottom", "column-bottom", "section-end"],
          "description": "Footnote position"
        },
        "separator": {
          "type": "object",
          "description": "Separator line settings",
          "properties": {
            "width": { "type": "string" },
            "style": { "type": "string" },
            "margin": { "type": "string" }
          }
        },
        "style": {
          "$ref": "#/$defs/style",
          "description": "Footnote text styling"
        }
      }
    },
    "endnotesConfig": {
      "type": "object",
      "description": "Endnote rendering settings",
      "properties": {
        "title": {
          "type": "string",
          "description": "Endnotes section title"
        },
        "numbering": {
          "type": "string",
          "description": "Numbering style",
          "enum": ["1", "a", "A", "i", "I"]
        },
        "perChapter": {
          "type": "boolean",
          "description": "Reset numbering per chapter"
        }
      }
    },
    "pageHeaderFooter": {
      "type": "object",
      "properties": {
        "height": {
          "type": "string",
          "description": "Height of header/footer"
        },
        "content": {
          "type": "object",
          "properties": {
            "left": {
              "$ref": "#/$defs/headerFooterContent"
            },
            "center": {
              "$ref": "#/$defs/headerFooterContent"
            },
            "right": {
              "$ref": "#/$defs/headerFooterContent"
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "headerFooterContent": {
      "oneOf": [
        { "type": "null" },
        {
          "type": "object",
          "properties": {
            "text": {
              "type": "string",
              "description": "Text with optional variables like {pageNumber}"
            },
            "variable": {
              "type": "string",
              "description": "Dynamic variable name (e.g., 'chapter-title', 'section-title', 'pageNumber')"
            }
          }
        }
      ]
    },
    "lineNumbering": {
      "type": "object",
      "description": "Line numbering configuration for margins",
      "required": ["enabled"],
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Whether line numbering is active"
        },
        "start": {
          "type": "integer",
          "description": "Starting line number",
          "minimum": 1,
          "default": 1
        },
        "interval": {
          "type": "integer",
          "description": "Number every N lines (1 = every line, 5 = every 5th line)",
          "minimum": 1,
          "default": 1
        },
        "side": {
          "type": "string",
          "description": "Which margin to display numbers",
          "enum": ["left", "right"],
          "default": "left"
        },
        "restart": {
          "type": "string",
          "description": "When to restart numbering",
          "enum": ["page", "section", "none"],
          "default": "page"
        },
        "scope": {
          "type": "array",
          "description": "Block types to number (if omitted, all content is numbered)",
          "items": { "type": "string" }
        },
        "style": {
          "type": "object",
          "description": "Styling for line numbers",
          "properties": {
            "fontSize": { "type": "string" },
            "color": { "type": "string" },
            "fontFamily": { "type": "string" },
            "marginRight": { "type": "string" },
            "marginLeft": { "type": "string" }
          }
        }
      }
    },
    "presentationReference": {
      "type": "object",
      "description": "Cross-reference block for figure/table/section references",
      "required": ["type", "target"],
      "properties": {
        "type": { "const": "presentation:reference" },
        "target": {
          "type": "string",
          "description": "Content Anchor URI (internal references start with #)"
        },
        "format": {
          "type": "string",
          "description": "Display format template (e.g., 'Figure #')"
        }
      }
    },
    "indexMark": {
      "type": "object",
      "description": "Index entry mark for document index generation",
      "required": ["type", "term"],
      "properties": {
        "type": { "const": "index" },
        "term": {
          "type": "string",
          "description": "Primary index term"
        },
        "subterm": {
          "type": "string",
          "description": "Secondary index term"
        }
      }
    },
    "style": {
      "type": "object",
      "properties": {
        "extends": {
          "type": "string",
          "description": "Parent style to inherit from"
        },
        "base": {
          "type": "object",
          "description": "Base styles (for responsive)"
        },
        "fontFamily": { "type": "string" },
        "fontSize": { "type": "string" },
        "fontWeight": {
          "oneOf": [
            { "type": "integer", "minimum": 100, "maximum": 900 },
            { "type": "string", "enum": ["normal", "bold", "lighter", "bolder"] }
          ]
        },
        "fontStyle": {
          "type": "string",
          "enum": ["normal", "italic"]
        },
        "fontFeatureSettings": {
          "type": "object",
          "description": "OpenType feature settings",
          "additionalProperties": { "type": "boolean" }
        },
        "fontVariationSettings": {
          "type": "object",
          "description": "Variable font axis settings",
          "additionalProperties": { "type": "number" }
        },
        "lineHeight": {
          "oneOf": [
            { "type": "number" },
            { "type": "string" }
          ]
        },
        "letterSpacing": { "type": "string" },
        "textAlign": {
          "type": "string",
          "enum": ["left", "center", "right", "justify"]
        },
        "textDecoration": {
          "type": "string",
          "enum": ["none", "underline", "line-through"]
        },
        "textTransform": {
          "type": "string",
          "enum": ["none", "uppercase", "lowercase", "capitalize"]
        },
        "writingMode": {
          "type": "string",
          "enum": ["horizontal-tb", "vertical-rl", "vertical-lr", "sideways-rl", "sideways-lr"],
          "description": "Text flow direction"
        },
        "color": { "type": "string" },
        "backgroundColor": { "type": "string" },
        "backgroundImage": {
          "type": "string",
          "description": "URL/path to background image"
        },
        "backgroundSize": {
          "type": "string",
          "description": "Background size (cover, contain, or dimensions)"
        },
        "backgroundPosition": {
          "type": "string",
          "description": "Background position"
        },
        "backgroundRepeat": {
          "type": "string",
          "enum": ["repeat", "no-repeat", "repeat-x", "repeat-y"],
          "description": "Background repeat behavior"
        },
        "opacity": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Element opacity (0-1)"
        },
        "marginTop": { "type": "string" },
        "marginRight": { "type": "string" },
        "marginBottom": { "type": "string" },
        "marginLeft": { "type": "string" },
        "paddingTop": { "type": "string" },
        "paddingRight": { "type": "string" },
        "paddingBottom": { "type": "string" },
        "paddingLeft": { "type": "string" },
        "borderWidth": { "type": "string" },
        "borderStyle": { "type": "string" },
        "borderColor": { "type": "string" },
        "borderRadius": {
          "type": "string",
          "description": "Corner rounding"
        },
        "boxShadow": {
          "type": "string",
          "description": "Box shadow effect"
        },
        "width": { "type": "string" },
        "height": { "type": "string" },
        "maxWidth": { "type": "string" },
        "maxHeight": { "type": "string" },
        "display": {
          "type": "string",
          "enum": ["block", "inline", "none"]
        },
        "pageBreakBefore": {
          "type": "string",
          "enum": ["auto", "always", "avoid"]
        },
        "pageBreakAfter": {
          "type": "string",
          "enum": ["auto", "always", "avoid"]
        },
        "dropCap": {
          "type": "object",
          "description": "Drop cap settings for first letter",
          "properties": {
            "lines": {
              "type": "integer",
              "minimum": 2,
              "description": "Number of lines to span"
            },
            "fontFamily": { "type": "string" },
            "fontWeight": {
              "oneOf": [
                { "type": "integer", "minimum": 100, "maximum": 900 },
                { "type": "string", "enum": ["normal", "bold", "lighter", "bolder", "inherit"] }
              ]
            },
            "marginRight": { "type": "string" }
          }
        },
        "overprint": {
          "type": "boolean",
          "description": "Enable overprint for this element (print only)"
        }
      },
      "additionalProperties": false
    },
    "float": {
      "type": "object",
      "description": "Float positioning for figures and images",
      "properties": {
        "position": {
          "type": "string",
          "enum": ["top", "bottom", "inline", "page-top", "page-bottom"],
          "description": "Float position preference"
        },
        "span": {
          "type": "string",
          "enum": ["column", "page", "spread"],
          "description": "Width span of the float"
        },
        "clearance": {
          "type": "string",
          "description": "Minimum clearance around float"
        }
      }
    }
  }
}
